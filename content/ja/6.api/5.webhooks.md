---
title: Webhooks
description: FluenzRイベントのリアルタイム通知を受け取ります。
---

# Webhooks

Webhooksを使用すると、FluenzRでイベントが発生したときにリアルタイム通知を受け取ることができます。

> **ℹ️ 情報**
Webhooksは**Pro**プランでのみ利用可能です。

## 仕組み

1. FluenzRでWebhook URLを設定
2. イベントが発生すると、FluenzRがあなたのURLにHTTP POSTリクエストを送信
3. あなたのサーバーがイベントを処理し、2xxコードで応答

## 利用可能なイベント

### 連絡先

| イベント | 説明 |
|-----------|-------------|
| `contact.created` | 新しい連絡先が作成された |
| `contact.updated` | 連絡先が更新された |
| `contact.deleted` | 連絡先が削除された |

### キャンペーン

| イベント | 説明 |
|-----------|-------------|
| `campaign.started` | キャンペーンが開始された |
| `campaign.paused` | キャンペーンが一時停止された |
| `campaign.completed` | キャンペーンが完了した |

### メール

| イベント | 説明 |
|-----------|-------------|
| `email.sent` | メールが送信された |
| `email.delivered` | メールが配信された |
| `email.opened` | メールが開封された |
| `email.clicked` | リンクがクリックされた |
| `email.replied` | 返信を受信した |
| `email.bounced` | バウンスが検出された |
| `email.unsubscribed` | 購読解除された |

## Webhookの作成

### インターフェース経由

1. **設定** > **Webhooks**に移動
2. **+ 新しいWebhook**をクリック
3. URLとイベントを設定
4. 保存

### API経由

```
POST /webhooks
```

```json
{
  "url": "https://your-server.com/webhooks/fluenzr",
  "events": [
    "email.sent",
    "email.opened",
    "email.replied"
  ],
  "secret": "your_webhook_secret"
}
```

### 例

```bash
curl -X POST "https://api.fluenzr.co/v1/webhooks" \
  -H "Authorization: Bearer flz_sk_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-server.com/webhooks/fluenzr",
    "events": ["email.opened", "email.replied"],
    "secret": "whsec_abc123"
  }'
```

### レスポンス

```json
{
  "success": true,
  "data": {
    "id": "whk_abc123",
    "url": "https://your-server.com/webhooks/fluenzr",
    "events": ["email.opened", "email.replied"],
    "status": "active",
    "createdAt": "2025-01-15T10:30:00Z"
  }
}
```

## ペイロード形式

### 一般構造

```json
{
  "id": "evt_abc123",
  "type": "email.opened",
  "timestamp": "2025-01-15T14:32:00Z",
  "data": {
    // イベント固有のデータ
  }
}
```

### email.sent

```json
{
  "id": "evt_abc123",
  "type": "email.sent",
  "timestamp": "2025-01-15T10:00:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "campaignName": "Q1プロスペクティング",
    "contactId": "con_def456",
    "contactEmail": "taro@example.com",
    "emailNodeId": "node_2",
    "emailSubject": "太郎さん、簡単な質問"
  }
}
```

### email.opened

```json
{
  "id": "evt_abc124",
  "type": "email.opened",
  "timestamp": "2025-01-15T14:32:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "contactId": "con_def456",
    "contactEmail": "taro@example.com",
    "emailNodeId": "node_2",
    "openCount": 1,
    "firstOpen": true,
    "userAgent": "Mozilla/5.0...",
    "ip": "192.168.1.1"
  }
}
```

### email.clicked

```json
{
  "id": "evt_abc125",
  "type": "email.clicked",
  "timestamp": "2025-01-15T14:35:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "contactId": "con_def456",
    "contactEmail": "taro@example.com",
    "emailNodeId": "node_2",
    "linkUrl": "https://fluenzr.co/demo",
    "clickCount": 1
  }
}
```

### email.replied

```json
{
  "id": "evt_abc126",
  "type": "email.replied",
  "timestamp": "2025-01-15T15:10:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "contactId": "con_def456",
    "contactEmail": "taro@example.com",
    "emailNodeId": "node_2",
    "replySubject": "Re: 太郎さん、簡単な質問",
    "replyPreview": "こんにちは、興味があります..."
  }
}
```

### email.bounced

```json
{
  "id": "evt_abc127",
  "type": "email.bounced",
  "timestamp": "2025-01-15T10:05:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "contactId": "con_def456",
    "contactEmail": "taro@example.com",
    "bounceType": "hard",
    "bounceReason": "User unknown"
  }
}
```

### contact.created

```json
{
  "id": "evt_abc128",
  "type": "contact.created",
  "timestamp": "2025-01-15T09:00:00Z",
  "data": {
    "contact": {
      "id": "con_def456",
      "email": "taro@example.com",
      "firstName": "太郎",
      "lastName": "山田",
      "company": "Acme Corp"
    }
  }
}
```

## 署名検証

各Webhookには真正性を検証するための署名が含まれています。

### ヘッダー

```
X-FluenzR-Signature: sha256=abc123...
X-FluenzR-Timestamp: 1640000000
```

### 検証（Node.js）

```javascript
const crypto = require('crypto');

function verifyWebhookSignature(payload, signature, timestamp, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(`${timestamp}.${payload}`)
    .digest('hex');

  return `sha256=${expectedSignature}` === signature;
}

// エンドポイント内で
app.post('/webhooks/fluenzr', (req, res) => {
  const signature = req.headers['x-fluenzr-signature'];
  const timestamp = req.headers['x-fluenzr-timestamp'];
  const payload = JSON.stringify(req.body);

  if (!verifyWebhookSignature(payload, signature, timestamp, WEBHOOK_SECRET)) {
    return res.status(401).send('Invalid signature');
  }

  // イベントを処理
  const event = req.body;
  console.log(`Event received: ${event.type}`);

  res.status(200).send('OK');
});
```

### 検証（Python）

```python
import hmac
import hashlib

def verify_webhook_signature(payload, signature, timestamp, secret):
    expected = hmac.new(
        secret.encode(),
        f"{timestamp}.{payload}".encode(),
        hashlib.sha256
    ).hexdigest()

    return f"sha256={expected}" == signature

# Flaskエンドポイント内で
@app.route('/webhooks/fluenzr', methods=['POST'])
def handle_webhook():
    signature = request.headers.get('X-FluenzR-Signature')
    timestamp = request.headers.get('X-FluenzR-Timestamp')
    payload = request.get_data(as_text=True)

    if not verify_webhook_signature(payload, signature, timestamp, WEBHOOK_SECRET):
        return 'Invalid signature', 401

    event = request.get_json()
    print(f"Event received: {event['type']}")

    return 'OK', 200
```

## リトライ処理

FluenzRは失敗したWebhookを自動的にリトライします：

| 試行回数 | 遅延 |
|-----------|-------|
| 1 | 即時 |
| 2 | 1分 |
| 3 | 5分 |
| 4 | 30分 |
| 5 | 2時間 |

5回失敗すると、Webhookは「failed」とマークされます。

### 成功コード

サーバーは30秒以内にHTTP 2xxコードで応答する必要があります。

| コード | 結果 |
|------|----------|
| 200-299 | 成功 |
| 3xx | リトライ |
| 4xx | 永久的な失敗 |
| 5xx | リトライ |
| タイムアウト | リトライ |

## Webhookの管理

### Webhook一覧

```
GET /webhooks
```

### Webhookの更新

```
PUT /webhooks/:id
```

```json
{
  "events": ["email.opened", "email.replied", "email.clicked"]
}
```

### Webhookの削除

```
DELETE /webhooks/:id
```

### Webhookのテスト

```
POST /webhooks/:id/test
```

あなたのURLにテストイベントを送信します。

### ログの表示

```
GET /webhooks/:id/logs
```

配信試行の履歴を取得します。

```json
{
  "success": true,
  "data": [
    {
      "id": "log_abc123",
      "eventId": "evt_xyz789",
      "eventType": "email.opened",
      "status": "delivered",
      "statusCode": 200,
      "responseTime": 145,
      "timestamp": "2025-01-15T14:32:00Z"
    }
  ]
}
```

## ベストプラクティス

### 迅速な応答

エンドポイントは30秒以内に応答する必要があります。必要に応じてバックグラウンドで処理を行ってください。

### べき等性

コードは重複イベントを処理できる必要があります。イベントIDを使用して重複を排除してください。

### モニタリング

Webhookを監視：
- 成功率
- レスポンスタイム
- 頻繁なエラー

### セキュリティ

- 常に署名を検証
- HTTPSのみを使用
- タイムスタンプを検証（5分以上経過している場合は拒否）
