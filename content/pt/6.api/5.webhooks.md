---
title: Webhooks
description: Receba notificações em tempo real sobre eventos do FluenzR.
---

# Webhooks

Os webhooks permitem que você receba notificações em tempo real quando eventos ocorrem no FluenzR.

> **Info**
Os webhooks estão disponíveis apenas no plano **Pro**.

## Como funciona

1. Você configura uma URL de webhook no FluenzR
2. Quando um evento ocorre, o FluenzR envia uma solicitação HTTP POST para sua URL
3. Seu servidor processa o evento e responde com um código 2xx

## Eventos disponíveis

### Contatos

| Evento | Descrição |
|--------|-----------|
| `contact.created` | Novo contato criado |
| `contact.updated` | Contato atualizado |
| `contact.deleted` | Contato excluído |

### Campanhas

| Evento | Descrição |
|--------|-----------|
| `campaign.started` | Campanha iniciada |
| `campaign.paused` | Campanha pausada |
| `campaign.completed` | Campanha concluída |

### Emails

| Evento | Descrição |
|--------|-----------|
| `email.sent` | Email enviado |
| `email.delivered` | Email entregue |
| `email.opened` | Email aberto |
| `email.clicked` | Link clicado |
| `email.replied` | Resposta recebida |
| `email.bounced` | Bounce detectado |
| `email.unsubscribed` | Cancelamento de inscrição |

## Criar um webhook

### Via interface

1. Vá em **Configurações** > **Webhooks**
2. Clique em **+ Novo webhook**
3. Configure a URL e os eventos
4. Salve

### Via API

```
POST /webhooks
```

```json
{
  "url": "https://your-server.com/webhooks/fluenzr",
  "events": [
    "email.sent",
    "email.opened",
    "email.replied"
  ],
  "secret": "your_webhook_secret"
}
```

### Exemplo

```bash
curl -X POST "https://api.fluenzr.co/v1/webhooks" \
  -H "Authorization: Bearer flz_sk_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-server.com/webhooks/fluenzr",
    "events": ["email.opened", "email.replied"],
    "secret": "whsec_abc123"
  }'
```

### Resposta

```json
{
  "success": true,
  "data": {
    "id": "whk_abc123",
    "url": "https://your-server.com/webhooks/fluenzr",
    "events": ["email.opened", "email.replied"],
    "status": "active",
    "createdAt": "2025-01-15T10:30:00Z"
  }
}
```

## Formato dos payloads

### Estrutura geral

```json
{
  "id": "evt_abc123",
  "type": "email.opened",
  "timestamp": "2025-01-15T14:32:00Z",
  "data": {
    // Dados específicos do evento
  }
}
```

### email.sent

```json
{
  "id": "evt_abc123",
  "type": "email.sent",
  "timestamp": "2025-01-15T10:00:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "campaignName": "Prospecção Q1",
    "contactId": "con_def456",
    "contactEmail": "joao@example.com",
    "emailNodeId": "node_2",
    "emailSubject": "João, pergunta rápida"
  }
}
```

### email.opened

```json
{
  "id": "evt_abc124",
  "type": "email.opened",
  "timestamp": "2025-01-15T14:32:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "contactId": "con_def456",
    "contactEmail": "joao@example.com",
    "emailNodeId": "node_2",
    "openCount": 1,
    "firstOpen": true,
    "userAgent": "Mozilla/5.0...",
    "ip": "192.168.1.1"
  }
}
```

### email.clicked

```json
{
  "id": "evt_abc125",
  "type": "email.clicked",
  "timestamp": "2025-01-15T14:35:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "contactId": "con_def456",
    "contactEmail": "joao@example.com",
    "emailNodeId": "node_2",
    "linkUrl": "https://fluenzr.co/demo",
    "clickCount": 1
  }
}
```

### email.replied

```json
{
  "id": "evt_abc126",
  "type": "email.replied",
  "timestamp": "2025-01-15T15:10:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "contactId": "con_def456",
    "contactEmail": "joao@example.com",
    "emailNodeId": "node_2",
    "replySubject": "Re: João, pergunta rápida",
    "replyPreview": "Olá, estaria interessado em..."
  }
}
```

### email.bounced

```json
{
  "id": "evt_abc127",
  "type": "email.bounced",
  "timestamp": "2025-01-15T10:05:00Z",
  "data": {
    "campaignId": "cmp_xyz789",
    "contactId": "con_def456",
    "contactEmail": "joao@example.com",
    "bounceType": "hard",
    "bounceReason": "User unknown"
  }
}
```

### contact.created

```json
{
  "id": "evt_abc128",
  "type": "contact.created",
  "timestamp": "2025-01-15T09:00:00Z",
  "data": {
    "contact": {
      "id": "con_def456",
      "email": "joao@example.com",
      "firstName": "João",
      "lastName": "Silva",
      "company": "Acme Corp"
    }
  }
}
```

## Verificação de assinatura

Cada webhook inclui uma assinatura para verificar sua autenticidade.

### Cabeçalhos

```
X-FluenzR-Signature: sha256=abc123...
X-FluenzR-Timestamp: 1640000000
```

### Verificação (Node.js)

```javascript
const crypto = require('crypto');

function verifyWebhookSignature(payload, signature, timestamp, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(`${timestamp}.${payload}`)
    .digest('hex');

  return `sha256=${expectedSignature}` === signature;
}

// No seu endpoint
app.post('/webhooks/fluenzr', (req, res) => {
  const signature = req.headers['x-fluenzr-signature'];
  const timestamp = req.headers['x-fluenzr-timestamp'];
  const payload = JSON.stringify(req.body);

  if (!verifyWebhookSignature(payload, signature, timestamp, WEBHOOK_SECRET)) {
    return res.status(401).send('Invalid signature');
  }

  // Processar o evento
  const event = req.body;
  console.log(`Event received: ${event.type}`);

  res.status(200).send('OK');
});
```

### Verificação (Python)

```python
import hmac
import hashlib

def verify_webhook_signature(payload, signature, timestamp, secret):
    expected = hmac.new(
        secret.encode(),
        f"{timestamp}.{payload}".encode(),
        hashlib.sha256
    ).hexdigest()

    return f"sha256={expected}" == signature

# No seu endpoint Flask
@app.route('/webhooks/fluenzr', methods=['POST'])
def handle_webhook():
    signature = request.headers.get('X-FluenzR-Signature')
    timestamp = request.headers.get('X-FluenzR-Timestamp')
    payload = request.get_data(as_text=True)

    if not verify_webhook_signature(payload, signature, timestamp, WEBHOOK_SECRET):
        return 'Invalid signature', 401

    event = request.get_json()
    print(f"Event received: {event['type']}")

    return 'OK', 200
```

## Gerenciamento de novas tentativas

O FluenzR tenta automaticamente reenviar webhooks que falharam:

| Tentativa | Atraso |
|-----------|--------|
| 1 | Imediato |
| 2 | 1 minuto |
| 3 | 5 minutos |
| 4 | 30 minutos |
| 5 | 2 horas |

Após 5 falhas, o webhook é marcado como "failed".

### Códigos de sucesso

Seu servidor deve responder com um código HTTP 2xx em até 30 segundos.

| Código | Resultado |
|--------|-----------|
| 200-299 | Sucesso |
| 3xx | Nova tentativa |
| 4xx | Falha permanente |
| 5xx | Nova tentativa |
| Timeout | Nova tentativa |

## Gerenciar webhooks

### Listar webhooks

```
GET /webhooks
```

### Atualizar um webhook

```
PUT /webhooks/:id
```

```json
{
  "events": ["email.opened", "email.replied", "email.clicked"]
}
```

### Excluir um webhook

```
DELETE /webhooks/:id
```

### Testar um webhook

```
POST /webhooks/:id/test
```

Envia um evento de teste para sua URL.

### Ver logs

```
GET /webhooks/:id/logs
```

Recupera o histórico de tentativas de entrega.

```json
{
  "success": true,
  "data": [
    {
      "id": "log_abc123",
      "eventId": "evt_xyz789",
      "eventType": "email.opened",
      "status": "delivered",
      "statusCode": 200,
      "responseTime": 145,
      "timestamp": "2025-01-15T14:32:00Z"
    }
  ]
}
```

## Melhores práticas

### Responder rapidamente

Seu endpoint deve responder em menos de 30 segundos. Processe em segundo plano se necessário.

### Idempotência

Seu código deve lidar com eventos duplicados. Use o ID do evento para desduplicação.

### Monitoramento

Monitore seus webhooks:
- Taxa de sucesso
- Tempo de resposta
- Erros frequentes

### Segurança

- Sempre verifique a assinatura
- Use apenas HTTPS
- Valide o timestamp (rejeite se > 5 minutos)
